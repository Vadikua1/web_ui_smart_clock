<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Control System V2</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg: #1a0b2e;
  --grad: linear-gradient(135deg, #11051b, #2b1055, #180829);
  --glass: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
  --accent: #00d2ff;
  --text: #fff;
  --danger: #ff4444;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scrollbar-width: none; user-select: none; }
*::-webkit-scrollbar { display: none; }

body { margin: 0; background: var(--grad); color: var(--text); font-family: 'Roboto', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
.app { width: 100%; max-width: 420px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; padding: 20px; position: relative; }

/* HEADER */
.header { padding: 15px 0; text-align: center; margin-bottom: 5px; }
.title { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; letter-spacing: 2px; color: rgba(255,255,255,0.9); text-shadow: 0 0 10px rgba(0, 210, 255, 0.3); }

/* VIEWS */
.view { display: none; flex: 1; flex-direction: column; align-items: center; width: 100%; overflow-y: auto; padding-bottom: 100px; }
.view.active { display: flex; }

/* CARD */
.card {
  width: 100%;
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(10px);
  border-radius: 24px;
  padding: 20px;
  border: 1px solid var(--glass-border);
  display: flex; flex-direction: column; align-items: center;
}

/* CLOCK FACE */
.clock-face {
    width: 200px; height: 200px; border-radius: 50%;
    background: radial-gradient(circle at center, transparent 50%, rgba(0,0,0,0.4));
    border: 3px solid rgba(255,255,255,0.05);
    position: relative; margin-bottom: 10px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
}
.hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; border-radius: 4px; transform: translateX(-50%) rotate(0deg); }
.hour { width: 6px; height: 50px; background: #fff; z-index: 2; }
.minute { width: 4px; height: 75px; background: var(--accent); z-index: 3; }
.second { width: 2px; height: 85px; background: var(--danger); z-index: 4; }
.center-dot { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; border-radius: 50%; background: #fff; transform: translate(-50%, -50%); z-index: 5; }
.tick { position: absolute; width: 2px; height: 10px; background: rgba(255,255,255,0.3); left: 50%; transform-origin: center 100px; top: 0; }
.tick.major { width: 4px; height: 15px; background: #fff; }

/* --- NEW DIGITAL PICKER STYLES --- */
.digital-picker {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
    gap: 10px;
    background: rgba(0,0,0,0.2);
    padding: 15px;
    border-radius: 16px;
    border: 1px solid var(--glass-border);
}

.picker-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.picker-btn {
    background: transparent;
    border: none;
    color: var(--accent);
    font-size: 1.5rem;
    padding: 5px 15px;
    cursor: pointer;
    transition: 0.2s;
    opacity: 0.7;
}
.picker-btn:active { transform: scale(0.8); opacity: 1; color: #fff; }

.picker-val {
    font-family: 'Orbitron';
    font-size: 2rem;
    color: #fff;
    min-width: 50px;
    text-align: center;
    text-shadow: 0 0 10px var(--accent);
    margin: 5px 0;
}

.picker-sep {
    font-family: 'Orbitron';
    font-size: 2rem;
    color: #888;
    margin-top: -5px;
    animation: blink 2s infinite;
}

@keyframes blink { 50% { opacity: 0.3; } }

.set-btn {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    background: var(--accent);
    border-radius: 12px;
    border: none;
    color: #000;
    font-family: 'Orbitron';
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(0, 210, 255, 0.2);
    transition: 0.2s;
}
.set-btn:active { transform: scale(0.98); opacity: 0.8; }

.sync-btn {
    width: 100%; margin-top: 15px; padding: 12px;
    background: transparent; border: 1px solid var(--glass-border); border-radius: 12px;
    color: #888; font-family: 'Orbitron'; font-size: 0.8rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.sync-btn:active { background: rgba(255,255,255,0.1); color: #fff; border-color: #fff; }


/* LED & SLIDERS */
.switch-row { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 0.9rem; color: #aaa; }
.switch-row input[type="checkbox"] { display: none; } 
.ios-switch { position: relative; width: 44px; height: 24px; background: #333; border-radius: 20px; transition: 0.3s; }
.ios-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: 0.3s; }
input:checked + .ios-switch { background: var(--accent); }
input:checked + .ios-switch::after { transform: translateX(20px); }

.color-ring { width: 180px; height: 180px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin: 10px 0; position: relative; }
input[type="color"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

.slider-box { width: 100%; margin-top: 15px; }
.slider-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
input[type=range] { width: 100%; height: 6px; background: #333; border-radius: 10px; -webkit-appearance: none; outline: none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px var(--accent); }

.modes-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; margin-top: 20px; }
.mode-tag { background: rgba(255,255,255,0.05); padding: 12px; text-align: center; border-radius: 8px; font-size: 0.75rem; font-weight: bold; color: #aaa; cursor: pointer; border: 1px solid transparent; }
.mode-tag.active { background: var(--accent); color: #000; border-color: var(--accent); }

/* TIMER UI */
.timer-ui { display: flex; flex-direction: column; align-items: center; width: 100%; }
.play-btn { width: 70px; height: 70px; border-radius: 50%; background: var(--accent); border: none; color: #000; font-size: 1.8rem; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,210,255,0.3); }

/* NAV */
.nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #150a25; border: 1px solid var(--glass-border); border-radius: 40px; padding: 5px 10px; display: flex; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; }
.nav-btn { width: 50px; height: 50px; border-radius: 50%; color: rgba(255,255,255,0.4); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.nav-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent-glow); }
</style>
</head>
<body>

<div class="app">
    <div class="header">
        <div class="title">MEGAKNIGHT TOP CONTROL</div>
    </div>

    <div id="v-clock" class="view active">
        <div class="card">
            <div class="clock-face" id="clockFace">
                <div class="center-dot"></div>
                <div class="hand hour" id="hh"></div>
                <div class="hand minute" id="mh"></div>
                <div class="hand second" id="sh"></div>
            </div>
            
            <div style="font-family:'Orbitron'; font-size:2.5rem;" id="digTime">00:00</div>
            <div style="color:#888; font-size:0.9rem; margin-bottom: 5px" id="dateStr">--</div>

            <div class="digital-picker">
                <div class="picker-unit">
                    <button class="picker-btn" onclick="adjTime('ch', 1)"><i class="fa-solid fa-chevron-up"></i></button>
                    <div class="picker-val" id="ch-val">12</div>
                    <button class="picker-btn" onclick="adjTime('ch', -1)"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
                <div class="picker-sep">:</div>
                <div class="picker-unit">
                    <button class="picker-btn" onclick="adjTime('cm', 1)"><i class="fa-solid fa-chevron-up"></i></button>
                    <div class="picker-val" id="cm-val">00</div>
                    <button class="picker-btn" onclick="adjTime('cm', -1)"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
            </div>
            <button class="set-btn" onclick="setManTime()">ВСТАНОВИТИ ЧАС</button>

            <button class="sync-btn" onclick="syncBrowser()">
                <i class="fa-solid fa-arrows-rotate"></i> Синхронізувати з телефоном
            </button>
        </div>
    </div>

    <div id="v-led" class="view">
        <div class="card">
            <div class="switch-row">
                <span><i class="fa-solid fa-robot"></i> Авто (Lux)</span>
                <label>
                    <input type="checkbox" id="autoCheck" onclick="togAuto()">
                    <div class="ios-switch"></div>
                </label>
            </div>
            <div style="font-size:0.8rem; color:#666; width:100%; text-align:right; margin-bottom:10px" id="luxVal">Lux: --</div>

            <div class="color-ring" id="ring">
                <i class="fa-solid fa-lightbulb" style="font-size: 3rem; opacity: 0.5;"></i>
                <input type="color" id="cp" value="#00d2ff">
            </div>
            <div style="font-family:'Orbitron'; margin-bottom:15px" id="hexText">#00D2FF</div>

            <div class="slider-box">
                <div class="slider-label"><span>Яскравість</span><span id="brV">100%</span></div>
                <input type="range" id="br" min="0" max="100" value="100">
            </div>
            <div class="slider-box">
                <div class="slider-label"><span>Білий</span><span id="wV">0%</span></div>
                <input type="range" id="w" min="0" max="100" value="0">
            </div>
            <div class="slider-box">
                <div class="slider-label"><span>Швидкість</span><span id="spV">50%</span></div>
                <input type="range" id="sp" min="1" max="100" value="50">
            </div>

            <div class="modes-box">
                <div class="mode-tag active" onclick="sMode(0, this)">STATIC</div>
                <div class="mode-tag" onclick="sMode(1, this)">RAINBOW</div>
                <div class="mode-tag" onclick="sMode(2, this)">STROBE</div>
                <div class="mode-tag" onclick="sMode(3, this)">BREATH</div>
            </div>
        </div>
    </div>

    <div id="v-timer" class="view">
        <div class="card">
            <div id="t-select" class="timer-ui">
                <div style="font-family:'Orbitron'; font-size:1rem; color:#aaa; margin-bottom:10px">НАЛАШТУВАННЯ ТАЙМЕРА</div>
                
                <div class="digital-picker">
                    <div class="picker-unit">
                        <button class="picker-btn" onclick="adjTimer('th', 1)"><i class="fa-solid fa-chevron-up"></i></button>
                        <div class="picker-val" id="th-val">00</div>
                        <button class="picker-btn" onclick="adjTimer('th', -1)"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                    <div class="picker-sep">:</div>
                    <div class="picker-unit">
                        <button class="picker-btn" onclick="adjTimer('tm', 1)"><i class="fa-solid fa-chevron-up"></i></button>
                        <div class="picker-val" id="tm-val">05</div>
                        <button class="picker-btn" onclick="adjTimer('tm', -1)"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                    <div class="picker-sep">:</div>
                    <div class="picker-unit">
                        <button class="picker-btn" onclick="adjTimer('ts', 1)"><i class="fa-solid fa-chevron-up"></i></button>
                        <div class="picker-val" id="ts-val">00</div>
                        <button class="picker-btn" onclick="adjTimer('ts', -1)"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                </div>

                <button class="play-btn" onclick="startT()"><i class="fa-solid fa-play"></i></button>
            </div>

            <div id="t-run" class="timer-ui" style="display:none">
                <div style="color:#aaa; font-family:'Roboto'; margin-top:20px">ЗАЛИШИЛОСЬ</div>
                <div style="font-family:'Orbitron'; font-size:3.5rem; margin: 10px 0; text-shadow: 0 0 20px var(--accent);" id="t-disp">00:00:00</div>
                <button class="play-btn" style="background:#ff4444; box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);" onclick="stopT()">
                    <i class="fa-solid fa-stop"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="nav">
    <div class="nav-btn active" onclick="nav('v-clock', this)"><i class="fa-solid fa-clock"></i></div>
    <div class="nav-btn" onclick="nav('v-led', this)"><i class="fa-solid fa-lightbulb"></i></div>
    <div class="nav-btn" onclick="nav('v-timer', this)"><i class="fa-solid fa-hourglass-half"></i></div>
</div>

<script>
// --- CLOCK & LOGIC ---
const face = document.getElementById('clockFace');
for(let i=0;i<12;i++){
    let tk = document.createElement('div');
    tk.className = 'tick ' + (i%3==0?'major':'');
    tk.style.transform = `translateX(-50%) rotate(${i*30}deg)`;
    face.appendChild(tk);
}

let timeOffset = 0; 

function updateClock(){
    const d = new Date(Date.now() + timeOffset);
    const h=d.getHours(), m=d.getMinutes(), s=d.getSeconds();
    document.getElementById('sh').style.transform = `translateX(-50%) rotate(${s*6}deg)`;
    document.getElementById('mh').style.transform = `translateX(-50%) rotate(${m*6 + s*0.1}deg)`;
    document.getElementById('hh').style.transform = `translateX(-50%) rotate(${h%12*30 + m*0.5}deg)`;
    
    document.getElementById('digTime').innerText = 
        `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
    document.getElementById('dateStr').innerText = d.toLocaleDateString('uk-UA', {weekday:'long', day:'numeric', month:'long'});
}
setInterval(updateClock, 1000); updateClock();

// --- SEND HELPER ---
let ls=0;
function send(u){let n=Date.now();if(n-ls<50)return;ls=n;fetch(u).catch(()=>{})}

// --- DIGITAL PICKER LOGIC ---
let clockVals = { h: 12, m: 0 };
let timerVals = { h: 0, m: 5, s: 0 };

function pad(n) { return n.toString().padStart(2,'0'); }

function adjTime(type, dir) {
    if(type === 'ch') {
        clockVals.h += dir;
        if(clockVals.h > 23) clockVals.h = 0;
        if(clockVals.h < 0) clockVals.h = 23;
        document.getElementById('ch-val').innerText = pad(clockVals.h);
    } else {
        clockVals.m += dir;
        if(clockVals.m > 59) clockVals.m = 0;
        if(clockVals.m < 0) clockVals.m = 59;
        document.getElementById('cm-val').innerText = pad(clockVals.m);
    }
}

function adjTimer(type, dir) {
    if(type === 'th') {
        timerVals.h += dir;
        if(timerVals.h > 23) timerVals.h = 0;
        if(timerVals.h < 0) timerVals.h = 23;
        document.getElementById('th-val').innerText = pad(timerVals.h);
    } else if(type === 'tm') {
        timerVals.m += dir;
        if(timerVals.m > 59) timerVals.m = 0;
        if(timerVals.m < 0) timerVals.m = 59;
        document.getElementById('tm-val').innerText = pad(timerVals.m);
    } else {
        timerVals.s += dir;
        if(timerVals.s > 59) timerVals.s = 0;
        if(timerVals.s < 0) timerVals.s = 59;
        document.getElementById('ts-val').innerText = pad(timerVals.s);
    }
}

// --- SET MANUAL TIME ---
function setManTime() {
    const now = new Date();
    const target = new Date();
    target.setHours(clockVals.h, clockVals.m, 0); 
    timeOffset = target.getTime() - now.getTime();
    updateClock(); 
    fetch(`/time?h=${clockVals.h}&m=${clockVals.m}&s=0`).catch(()=>{});
}

function syncBrowser() {
    timeOffset = 0; 
    updateClock(); 
    const d = new Date();
    // Update picker visual too
    clockVals.h = d.getHours();
    clockVals.m = d.getMinutes();
    document.getElementById('ch-val').innerText = pad(clockVals.h);
    document.getElementById('cm-val').innerText = pad(clockVals.m);

    fetch(`/time?h=${d.getHours()}&m=${d.getMinutes()}&s=${d.getSeconds()}`).catch(()=>{});
}

// --- TIMER LOGIC ---
let tInt;
function startT() {
    let tot = timerVals.h*3600 + timerVals.m*60 + timerVals.s;
    if(tot <= 0) return;

    document.getElementById('t-select').style.display='none';
    document.getElementById('t-run').style.display='flex';

    // Update display immediately
    let hh = Math.floor(tot/3600), mm = Math.floor((tot%3600)/60), ss = tot%60;
    document.getElementById('t-disp').innerText = `${pad(hh)}:${pad(mm)}:${pad(ss)}`;

    tInt = setInterval(() => {
        tot--;
        if(tot < 0) { stopT(); return; }
        let hh = Math.floor(tot/3600), mm = Math.floor((tot%3600)/60), ss = tot%60;
        document.getElementById('t-disp').innerText = `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    }, 1000);
}
function stopT() {
    clearInterval(tInt);
    document.getElementById('t-run').style.display='none';
    document.getElementById('t-select').style.display='flex';
}

// --- LED LOGIC ---
function upd() {
    let h = document.getElementById('cp').value;
    let br = document.getElementById('br').value;
    let w = document.getElementById('w').value;
    let r=parseInt(h.slice(1,3),16), g=parseInt(h.slice(3,5),16), b=parseInt(h.slice(5,7),16);
    document.getElementById('brV').innerText = br+'%';
    document.getElementById('wV').innerText = w+'%';
    document.getElementById('hexText').innerText = h.toUpperCase();
    document.getElementById('ring').style.boxShadow = `0 0 30px ${h}`;
    send(`/set?r=${r}&g=${g}&b=${b}&br=${br}&w=${w}`);
}
document.getElementById('cp').addEventListener('input', upd);
document.getElementById('br').addEventListener('input', upd);
document.getElementById('w').addEventListener('input', upd);
document.getElementById('sp').addEventListener('input', (e)=>{
    document.getElementById('spV').innerText=e.target.value+'%';
    send(`/speed?val=${e.target.value}`);
});

function nav(id, el) {
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
}
function sMode(m, el) {
    document.querySelectorAll('.mode-tag').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    send(`/mode?val=${m}`);
}
function togAuto() {
    send('/auto?val='+(document.getElementById('autoCheck').checked?1:0));
}
setInterval(()=>{
    if(document.getElementById('v-led').classList.contains('active')) {
        fetch('/status').then(r=>r.json()).then(d=>{
            document.getElementById('luxVal').innerText = 'Lux: '+d.lux.toFixed(1);
            if(d.auto && !document.getElementById('autoCheck').checked) document.getElementById('autoCheck').checked=true;
        }).catch(()=>{});
    }
}, 2000);
</script>
</body>
</html>
